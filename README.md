# gun

我自己实现并一直使用的一个小工具，用于在路由器(OpenWRT)或内网小主机上透明代理流量。

## 使用方式

```bash
$ gun
Usage:
  gun [command]

Available Commands:
  setup       推测系统版本并安装必要的系统工具和规则文件。
  start       一键启动服务(域名服务、接管进程、代理进程)。
  stop        手动还原系统状态(不包括：内核参数、用户组)。
  update      安全地更新全部的规则配置文件。

Flags:
  -c, --config-dir string   配置文件目录。 (default "/etc/gun")
  -h, --help                help for gun

Use "gun [command] --help" for more information about a command.
```

### 安装必要的系统工具

为了简化，这些步骤已经按系统做好标准化了。

```bash
# 这个命令会检测系统类型和版本，安装必要的系统组件和工具。
$ gun setup
```

但是个人能力有限，无法完整进行覆盖测试。

### 初始化资源文件

程序正常运行需要一些规则文件，比如国内的域名列表、路由段等。
执行下面的命令可以自动从公开资源获取并保存到本地。

```bash
$ gun update
```

### 编写配置文件

配置文件非常简单，绝大部分配置默认，只需要配置一下出口参数即可。

```yaml
$ cat /etc/gun/gun.yaml
outputs:
  current: blog
  stocks:
    blog:
      http2socks:
        server: https://...
        token: ...
```

### 启动主程序命令

启动命令时，会自动配置好所需的一切配置：

1. 内核参数
2. 防火墙表、链和规则
3. 黑白路由名单 ipset
4. 系统路由接管
5. DNS请求接管
6. TCP/UDP接管

### 停止

直接结束主进程即可，会尽量把系统恢复到原始状态。

也可选随意执行 `gun stop` 命令，会结束掉所有相关进程。

## 支持的出口协议

* http2socks
* Trojan
* SSH
* SOCKS5

第一个是我自己的协议，并且常年来一直使用的协议。
后面几个协议是后备协议，因为实现简单，所以也一并实现了。

## 支持的入口协议

* tproxy

是的，仅这一个。
所有的流量均是由 tproxy 转发到其它出口上的。

## DNS 域名服务器（转发器）

域名服务器是我手动实现的一个内存内服务器，用于分流，所有数据缓存在内存中。

支持的功能：

* 域名分流解析（DoT）：常规域名直接解析，不可访问域名走代理后的TCP解析；
* 未知域名（不在任何列表内的域名）走检测逻辑：若国内可解析且结果属国内路由段，走国内分流；
* 解析结果自动添加到ipset，以通过iptables match set实现分流；
* 支持域名屏蔽功能（不允许访问指定列表内的域名）；
* 内存内缓存（最小TTL为5分钟）；

其运行的时候依赖几个主要配置文件全部位于 `/etc/gun` 下，看文件名或者其内的注释可以了解其用途。
